import { voidMap } from '../parser/tokenizer-event-handlers';
import { escapeText, escapeAttrValue } from './util';
function unreachable() {
    throw new Error('unreachable');
}
export default function build(ast, options = { entityEncoding: 'transformed' }) {
    if (!ast) {
        return '';
    }
    function buildEach(asts) {
        return asts.map(node => build(node, options));
    }
    function pathParams(ast) {
        let path;
        switch (ast.type) {
            case 'MustacheStatement':
            case 'SubExpression':
            case 'ElementModifierStatement':
            case 'BlockStatement':
                path = build(ast.path, options);
                break;
            case 'PartialStatement':
                path = build(ast.name, options);
                break;
            default:
                return unreachable();
        }
        return compactJoin([path, buildEach(ast.params).join(' '), build(ast.hash, options)], ' ');
    }
    function compactJoin(array, delimiter) {
        return compact(array).join(delimiter || '');
    }
    function blockParams(block) {
        const params = block.program.blockParams;
        if (params.length) {
            return ` as |${params.join(' ')}|`;
        }
        return null;
    }
    function openBlock(block) {
        return ['{{#', pathParams(block), blockParams(block), '}}'].join('');
    }
    function closeBlock(block) {
        return ['{{/', build(block.path, options), '}}'].join('');
    }
    const output = [];
    switch (ast.type) {
        case 'Program':
        case 'Block':
        case 'Template':
            {
                const chainBlock = ast.chained && ast.body[0];
                if (chainBlock) {
                    chainBlock.chained = true;
                }
                const body = buildEach(ast.body).join('');
                output.push(body);
            }
            break;
        case 'ElementNode':
            output.push('<', ast.tag);
            if (ast.attributes.length) {
                output.push(' ', buildEach(ast.attributes).join(' '));
            }
            if (ast.modifiers.length) {
                output.push(' ', buildEach(ast.modifiers).join(' '));
            }
            if (ast.comments.length) {
                output.push(' ', buildEach(ast.comments).join(' '));
            }
            if (ast.blockParams.length) {
                output.push(' ', 'as', ' ', `|${ast.blockParams.join(' ')}|`);
            }
            if (voidMap[ast.tag]) {
                if (ast.selfClosing) {
                    output.push(' /');
                }
                output.push('>');
            } else if (ast.selfClosing) {
                output.push(' />');
            } else {
                output.push('>');
                output.push.apply(output, buildEach(ast.children));
                output.push('</', ast.tag, '>');
            }
            break;
        case 'AttrNode':
            if (ast.value.type === 'TextNode') {
                if (ast.value.chars !== '') {
                    output.push(ast.name, '=');
                    output.push('"', options.entityEncoding === 'raw' ? ast.value.chars : escapeAttrValue(ast.value.chars), '"');
                } else {
                    output.push(ast.name);
                }
            } else {
                output.push(ast.name, '=');
                // ast.value is mustache or concat
                output.push(build(ast.value, options));
            }
            break;
        case 'ConcatStatement':
            output.push('"');
            ast.parts.forEach(node => {
                if (node.type === 'TextNode') {
                    output.push(options.entityEncoding === 'raw' ? node.chars : escapeAttrValue(node.chars));
                } else {
                    output.push(build(node, options));
                }
            });
            output.push('"');
            break;
        case 'TextNode':
            output.push(options.entityEncoding === 'raw' ? ast.chars : escapeText(ast.chars));
            break;
        case 'MustacheStatement':
            {
                output.push(compactJoin(['{{', pathParams(ast), '}}']));
            }
            break;
        case 'MustacheCommentStatement':
            {
                output.push(compactJoin(['{{!--', ast.value, '--}}']));
            }
            break;
        case 'ElementModifierStatement':
            {
                output.push(compactJoin(['{{', pathParams(ast), '}}']));
            }
            break;
        case 'PathExpression':
            output.push(ast.original);
            break;
        case 'SubExpression':
            {
                output.push('(', pathParams(ast), ')');
            }
            break;
        case 'BooleanLiteral':
            output.push(ast.value ? 'true' : 'false');
            break;
        case 'BlockStatement':
            {
                const lines = [];
                if (ast.chained) {
                    lines.push(['{{else ', pathParams(ast), '}}'].join(''));
                } else {
                    lines.push(openBlock(ast));
                }
                lines.push(build(ast.program, options));
                if (ast.inverse) {
                    if (!ast.inverse.chained) {
                        lines.push('{{else}}');
                    }
                    lines.push(build(ast.inverse, options));
                }
                if (!ast.chained) {
                    lines.push(closeBlock(ast));
                }
                output.push(lines.join(''));
            }
            break;
        case 'PartialStatement':
            {
                output.push(compactJoin(['{{>', pathParams(ast), '}}']));
            }
            break;
        case 'CommentStatement':
            {
                output.push(compactJoin(['<!--', ast.value, '-->']));
            }
            break;
        case 'StringLiteral':
            {
                output.push(`"${ast.value}"`);
            }
            break;
        case 'NumberLiteral':
            {
                output.push(String(ast.value));
            }
            break;
        case 'UndefinedLiteral':
            {
                output.push('undefined');
            }
            break;
        case 'NullLiteral':
            {
                output.push('null');
            }
            break;
        case 'Hash':
            {
                output.push(ast.pairs.map(pair => {
                    return build(pair, options);
                }).join(' '));
            }
            break;
        case 'HashPair':
            {
                output.push(`${ast.key}=${build(ast.value, options)}`);
            }
            break;
    }
    return output.join('');
}
function compact(array) {
    const newArray = [];
    array.forEach(a => {
        if (typeof a !== 'undefined' && a !== null && a !== '') {
            newArray.push(a);
        }
    });
    return newArray;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL3N5bnRheC9saWIvZ2VuZXJhdGlvbi9wcmludC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxTQUFTLE9BQVQsUUFBd0Isb0NBQXhCO0FBQ0EsU0FBUyxVQUFULEVBQXFCLGVBQXJCLFFBQTRDLFFBQTVDO0FBRUEsU0FBUyxXQUFULEdBQW9CO0FBQ2xCLFVBQU0sSUFBSSxLQUFKLENBQVUsYUFBVixDQUFOO0FBQ0Q7QUFNRCxlQUFjLFNBQVUsS0FBVixDQUNaLEdBRFksRUFFWixVQUEwQixFQUFFLGdCQUFnQixhQUFsQixFQUZkLEVBRStDO0FBRTNELFFBQUksQ0FBQyxHQUFMLEVBQVU7QUFDUixlQUFPLEVBQVA7QUFDRDtBQUVELGFBQVMsU0FBVCxDQUFtQixJQUFuQixFQUFtQztBQUNqQyxlQUFPLEtBQUssR0FBTCxDQUFTLFFBQVEsTUFBTSxJQUFOLEVBQVksT0FBWixDQUFqQixDQUFQO0FBQ0Q7QUFFRCxhQUFTLFVBQVQsQ0FBb0IsR0FBcEIsRUFBaUM7QUFDL0IsWUFBSSxJQUFKO0FBRUEsZ0JBQVEsSUFBSSxJQUFaO0FBQ0UsaUJBQUssbUJBQUw7QUFDQSxpQkFBSyxlQUFMO0FBQ0EsaUJBQUssMEJBQUw7QUFDQSxpQkFBSyxnQkFBTDtBQUNFLHVCQUFPLE1BQU0sSUFBSSxJQUFWLEVBQWdCLE9BQWhCLENBQVA7QUFDQTtBQUNGLGlCQUFLLGtCQUFMO0FBQ0UsdUJBQU8sTUFBTSxJQUFJLElBQVYsRUFBZ0IsT0FBaEIsQ0FBUDtBQUNBO0FBQ0Y7QUFDRSx1QkFBTyxhQUFQO0FBWEo7QUFjQSxlQUFPLFlBQVksQ0FBQyxJQUFELEVBQU8sVUFBVSxJQUFJLE1BQWQsRUFBc0IsSUFBdEIsQ0FBMkIsR0FBM0IsQ0FBUCxFQUF3QyxNQUFNLElBQUksSUFBVixFQUFnQixPQUFoQixDQUF4QyxDQUFaLEVBQStFLEdBQS9FLENBQVA7QUFDRDtBQUVELGFBQVMsV0FBVCxDQUFxQixLQUFy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OEtBLFdBQU8sT0FBTyxJQUFQLENBQVksRUFBWixDQUFQO0FBQ0Q7QUFFRCxTQUFTLE9BQVQsQ0FBaUIsS0FBakIsRUFBd0M7QUFDdEMsVUFBTSxXQUFrQixFQUF4QjtBQUNBLFVBQU0sT0FBTixDQUFjLEtBQUk7QUFDaEIsWUFBSSxPQUFPLENBQVAsS0FBYSxXQUFiLElBQTRCLE1BQU0sSUFBbEMsSUFBMEMsTUFBTSxFQUFwRCxFQUF3RDtBQUN0RCxxQkFBUyxJQUFULENBQWMsQ0FBZDtBQUNEO0FBQ0YsS0FKRDtBQUtBLFdBQU8sUUFBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT3B0aW9uIH0gZnJvbSAnQGdsaW1tZXIvaW50ZXJmYWNlcyc7XG5pbXBvcnQgKiBhcyBBU1QgZnJvbSAnLi4vdHlwZXMvbm9kZXMnO1xuaW1wb3J0IHsgdm9pZE1hcCB9IGZyb20gJy4uL3BhcnNlci90b2tlbml6ZXItZXZlbnQtaGFuZGxlcnMnO1xuaW1wb3J0IHsgZXNjYXBlVGV4dCwgZXNjYXBlQXR0clZhbHVlIH0gZnJvbSAnLi91dGlsJztcblxuZnVuY3Rpb24gdW5yZWFjaGFibGUoKTogbmV2ZXIge1xuICB0aHJvdyBuZXcgRXJyb3IoJ3VucmVhY2hhYmxlJyk7XG59XG5cbmludGVyZmFjZSBQcmludGVyT3B0aW9ucyB7XG4gIGVudGl0eUVuY29kaW5nOiAndHJhbnNmb3JtZWQnIHwgJ3Jhdyc7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIGJ1aWxkKFxuICBhc3Q6IEFTVC5Ob2RlLFxuICBvcHRpb25zOiBQcmludGVyT3B0aW9ucyA9IHsgZW50aXR5RW5jb2Rpbmc6ICd0cmFuc2Zvcm1lZCcgfVxuKTogc3RyaW5nIHtcbiAgaWYgKCFhc3QpIHtcbiAgICByZXR1cm4gJyc7XG4gIH1cblxuICBmdW5jdGlvbiBidWlsZEVhY2goYXN0czogQVNULk5vZGVbXSk6IHN0cmluZ1tdIHtcbiAgICByZXR1cm4gYXN0cy5tYXAobm9kZSA9PiBidWlsZChub2RlLCBvcHRpb25zKSk7XG4gIH1cblxuICBmdW5jdGlvbiBwYXRoUGFyYW1zKGFzdDogQVNULk5vZGUpOiBzdHJpbmcge1xuICAgIGxldCBwYXRoOiBzdHJpbmc7XG5cbiAgICBzd2l0Y2ggKGFzdC50eXBlKSB7XG4gICAgICBjYXNlICdNdXN0YWNoZVN0YXRlbWVudCc6XG4gICAgICBjYXNlICdTdWJFeHByZXNzaW9uJzpcbiAgICAgIGNhc2UgJ0VsZW1lbnRNb2RpZmllclN0YXRlbWVudCc6XG4gICAgICBjYXNlICdCbG9ja1N0YXRlbWVudCc6XG4gICAgICAgIHBhdGggPSBidWlsZChhc3QucGF0aCwgb3B0aW9ucyk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnUGFydGlhbFN0YXRlbWVudCc6XG4gICAgICAgIHBhdGggPSBidWlsZChhc3QubmFtZSwgb3B0aW9ucyk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIHVucmVhY2hhYmxlKCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNvbXBhY3RKb2luKFtwYXRoLCBidWlsZEVhY2goYXN0LnBhcmFtcykuam9pbignICcpLCBidWlsZChhc3QuaGFzaCwgb3B0aW9ucyldLCAnICcpO1xuICB9XG5cbiAgZnVuY3Rpb24gY29tcGFjdEpvaW4oYXJyYXk6IE9wdGlvbjxzdHJpbmc+W10sIGRlbGltaXRlcj86IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGNvbXBhY3QoYXJyYXkpLmpvaW4oZGVsaW1pdGVyIHx8ICcnKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGJsb2NrUGFyYW1zKGJsb2NrOiBBU1QuQmxvY2tTdGF0ZW1lbnQpOiBPcHRpb248c3RyaW5nPiB7XG4gICAgY29uc3QgcGFyYW1zID0gYmxvY2sucHJvZ3JhbS5ibG9ja1BhcmFtcztcbiAgICBpZiAocGFyYW1zLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIGAgYXMgfCR7cGFyYW1zLmpvaW4oJyAnKX18YDtcbiAgICB9XG5cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGZ1bmN0aW9uIG9wZW5CbG9jayhibG9jazogQVNULkJsb2NrU3RhdGVtZW50KTogc3RyaW5nIHtcbiAgICByZXR1cm4gWyd7eyMnLCBwYXRoUGFyYW1zKGJsb2NrKSwgYmxvY2tQYXJhbXMoYmxvY2spLCAnfX0nXS5qb2luKCcnKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGNsb3NlQmxvY2soYmxvY2s6IGFueSk6IHN0cmluZyB7XG4gICAgcmV0dXJuIFsne3svJywgYnVpbGQoYmxvY2sucGF0aCwgb3B0aW9ucyksICd9fSddLmpvaW4oJycpO1xuICB9XG5cbiAgY29uc3Qgb3V0cHV0OiBzdHJpbmdbXSA9IFtdO1xuXG4gIHN3aXRjaCAoYXN0LnR5cGUpIHtcbiAgICBjYXNlICdQcm9ncmFtJzpcbiAgICBjYXNlICdCbG9jayc6XG4gICAgY2FzZSAnVGVtcGxhdGUnOlxuICAgICAge1xuICAgICAgICBjb25zdCBjaGFpbkJsb2NrID0gYXN0LmNoYWluZWQgJiYgYXN0LmJvZHlbMF07XG4gICAgICAgIGlmIChjaGFpbkJsb2NrKSB7XG4gICAgICAgICAgKGNoYWluQmxvY2sgYXMgQVNULkJsb2NrU3RhdGVtZW50KS5jaGFpbmVkID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBib2R5ID0gYnVpbGRFYWNoKGFzdC5ib2R5KS5qb2luKCcnKTtcbiAgICAgICAgb3V0cHV0LnB1c2goYm9keSk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdFbGVtZW50Tm9kZSc6XG4gICAgICBvdXRwdXQucHVzaCgnPCcsIGFzdC50YWcpO1xuICAgICAgaWYgKGFzdC5hdHRyaWJ1dGVzLmxlbmd0aCkge1xuICAgICAgICBvdXRwdXQucHVzaCgnICcsIGJ1aWxkRWFjaChhc3QuYXR0cmlidXRlcykuam9pbignICcpKTtcbiAgICAgIH1cbiAgICAgIGlmIChhc3QubW9kaWZpZXJzLmxlbmd0aCkge1xuICAgICAgICBvdXRwdXQucHVzaCgnICcsIGJ1aWxkRWFjaChhc3QubW9kaWZpZXJzKS5qb2luKCcgJykpO1xuICAgICAgfVxuICAgICAgaWYgKGFzdC5jb21tZW50cy5sZW5ndGgpIHtcbiAgICAgICAgb3V0cHV0LnB1c2goJyAnLCBidWlsZEVhY2goYXN0LmNvbW1lbnRzKS5qb2luKCcgJykpO1xuICAgICAgfVxuXG4gICAgICBpZiAoYXN0LmJsb2NrUGFyYW1zLmxlbmd0aCkge1xuICAgICAgICBvdXRwdXQucHVzaCgnICcsICdhcycsICcgJywgYHwke2FzdC5ibG9ja1BhcmFtcy5qb2luKCcgJyl9fGApO1xuICAgICAgfVxuXG4gICAgICBpZiAodm9pZE1hcFthc3QudGFnXSkge1xuICAgICAgICBpZiAoYXN0LnNlbGZDbG9zaW5nKSB7XG4gICAgICAgICAgb3V0cHV0LnB1c2goJyAvJyk7XG4gICAgICAgIH1cblxuICAgICAgICBvdXRwdXQucHVzaCgnPicpO1xuICAgICAgfSBlbHNlIGlmIChhc3Quc2VsZkNsb3NpbmcpIHtcbiAgICAgICAgb3V0cHV0LnB1c2goJyAvPicpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgb3V0cHV0LnB1c2goJz4nKTtcbiAgICAgICAgb3V0cHV0LnB1c2guYXBwbHkob3V0cHV0LCBidWlsZEVhY2goYXN0LmNoaWxkcmVuKSk7XG4gICAgICAgIG91dHB1dC5wdXNoKCc8LycsIGFzdC50YWcsICc+Jyk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdBdHRyTm9kZSc6XG4gICAgICBpZiAoYXN0LnZhbHVlLnR5cGUgPT09ICdUZXh0Tm9kZScpIHtcbiAgICAgICAgaWYgKGFzdC52YWx1ZS5jaGFycyAhPT0gJycpIHtcbiAgICAgICAgICBvdXRwdXQucHVzaChhc3QubmFtZSwgJz0nKTtcbiAgICAgICAgICBvdXRwdXQucHVzaChcbiAgICAgICAgICAgICdcIicsXG4gICAgICAgICAgICBvcHRpb25zLmVudGl0eUVuY29kaW5nID09PSAncmF3JyA/IGFzdC52YWx1ZS5jaGFycyA6IGVzY2FwZUF0dHJWYWx1ZShhc3QudmFsdWUuY2hhcnMpLFxuICAgICAgICAgICAgJ1wiJ1xuICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgb3V0cHV0LnB1c2goYXN0Lm5hbWUpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvdXRwdXQucHVzaChhc3QubmFtZSwgJz0nKTtcbiAgICAgICAgLy8gYXN0LnZhbHVlIGlzIG11c3RhY2hlIG9yIGNvbmNhdFxuICAgICAgICBvdXRwdXQucHVzaChidWlsZChhc3QudmFsdWUsIG9wdGlvbnMpKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ0NvbmNhdFN0YXRlbWVudCc6XG4gICAgICBvdXRwdXQucHVzaCgnXCInKTtcbiAgICAgIGFzdC5wYXJ0cy5mb3JFYWNoKChub2RlOiBBU1QuVGV4dE5vZGUgfCBBU1QuTXVzdGFjaGVTdGF0ZW1lbnQpID0+IHtcbiAgICAgICAgaWYgKG5vZGUudHlwZSA9PT0gJ1RleHROb2RlJykge1xuICAgICAgICAgIG91dHB1dC5wdXNoKG9wdGlvbnMuZW50aXR5RW5jb2RpbmcgPT09ICdyYXcnID8gbm9kZS5jaGFycyA6IGVzY2FwZUF0dHJWYWx1ZShub2RlLmNoYXJzKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgb3V0cHV0LnB1c2goYnVpbGQobm9kZSwgb3B0aW9ucykpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIG91dHB1dC5wdXNoKCdcIicpO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnVGV4dE5vZGUnOlxuICAgICAgb3V0cHV0LnB1c2gob3B0aW9ucy5lbnRpdHlFbmNvZGluZyA9PT0gJ3JhdycgPyBhc3QuY2hhcnMgOiBlc2NhcGVUZXh0KGFzdC5jaGFycykpO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnTXVzdGFjaGVTdGF0ZW1lbnQnOlxuICAgICAge1xuICAgICAgICBvdXRwdXQucHVzaChjb21wYWN0Sm9pbihbJ3t7JywgcGF0aFBhcmFtcyhhc3QpLCAnfX0nXSkpO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnTXVzdGFjaGVDb21tZW50U3RhdGVtZW50JzpcbiAgICAgIHtcbiAgICAgICAgb3V0cHV0LnB1c2goY29tcGFjdEpvaW4oWyd7eyEtLScsIGFzdC52YWx1ZSwgJy0tfX0nXSkpO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnRWxlbWVudE1vZGlmaWVyU3RhdGVtZW50JzpcbiAgICAgIHtcbiAgICAgICAgb3V0cHV0LnB1c2goY29tcGFjdEpvaW4oWyd7eycsIHBhdGhQYXJhbXMoYXN0KSwgJ319J10pKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ1BhdGhFeHByZXNzaW9uJzpcbiAgICAgIG91dHB1dC5wdXNoKGFzdC5vcmlnaW5hbCk7XG4gICAgICBicmVhaztcbiAgICBjYXNlICdTdWJFeHByZXNzaW9uJzpcbiAgICAgIHtcbiAgICAgICAgb3V0cHV0LnB1c2goJygnLCBwYXRoUGFyYW1zKGFzdCksICcpJyk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdCb29sZWFuTGl0ZXJhbCc6XG4gICAgICBvdXRwdXQucHVzaChhc3QudmFsdWUgPyAndHJ1ZScgOiAnZmFsc2UnKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ0Jsb2NrU3RhdGVtZW50JzpcbiAgICAgIHtcbiAgICAgICAgY29uc3QgbGluZXM6IHN0cmluZ1tdID0gW107XG5cbiAgICAgICAgaWYgKGFzdC5jaGFpbmVkKSB7XG4gICAgICAgICAgbGluZXMucHVzaChbJ3t7ZWxzZSAnLCBwYXRoUGFyYW1zKGFzdCksICd9fSddLmpvaW4oJycpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBsaW5lcy5wdXNoKG9wZW5CbG9jayhhc3QpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxpbmVzLnB1c2goYnVpbGQoYXN0LnByb2dyYW0sIG9wdGlvbnMpKTtcblxuICAgICAgICBpZiAoYXN0LmludmVyc2UpIHtcbiAgICAgICAgICBpZiAoIWFzdC5pbnZlcnNlLmNoYWluZWQpIHtcbiAgICAgICAgICAgIGxpbmVzLnB1c2goJ3t7ZWxzZX19Jyk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGxpbmVzLnB1c2goYnVpbGQoYXN0LmludmVyc2UsIG9wdGlvbnMpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghYXN0LmNoYWluZWQpIHtcbiAgICAgICAgICBsaW5lcy5wdXNoKGNsb3NlQmxvY2soYXN0KSk7XG4gICAgICAgIH1cblxuICAgICAgICBvdXRwdXQucHVzaChsaW5lcy5qb2luKCcnKSk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdQYXJ0aWFsU3RhdGVtZW50JzpcbiAgICAgIHtcbiAgICAgICAgb3V0cHV0LnB1c2goY29tcGFjdEpvaW4oWyd7ez4nLCBwYXRoUGFyYW1zKGFzdCksICd9fSddKSk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdDb21tZW50U3RhdGVtZW50JzpcbiAgICAgIHtcbiAgICAgICAgb3V0cHV0LnB1c2goY29tcGFjdEpvaW4oWyc8IS0tJywgYXN0LnZhbHVlLCAnLS0+J10pKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ1N0cmluZ0xpdGVyYWwnOlxuICAgICAge1xuICAgICAgICBvdXRwdXQucHVzaChgXCIke2FzdC52YWx1ZX1cImApO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnTnVtYmVyTGl0ZXJhbCc6XG4gICAgICB7XG4gICAgICAgIG91dHB1dC5wdXNoKFN0cmluZyhhc3QudmFsdWUpKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ1VuZGVmaW5lZExpdGVyYWwnOlxuICAgICAge1xuICAgICAgICBvdXRwdXQucHVzaCgndW5kZWZpbmVkJyk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdOdWxsTGl0ZXJhbCc6XG4gICAgICB7XG4gICAgICAgIG91dHB1dC5wdXNoKCdudWxsJyk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdIYXNoJzpcbiAgICAgIHtcbiAgICAgICAgb3V0cHV0LnB1c2goXG4gICAgICAgICAgYXN0LnBhaXJzXG4gICAgICAgICAgICAubWFwKHBhaXIgPT4ge1xuICAgICAgICAgICAgICByZXR1cm4gYnVpbGQocGFpciwgb3B0aW9ucyk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLmpvaW4oJyAnKVxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnSGFzaFBhaXInOlxuICAgICAge1xuICAgICAgICBvdXRwdXQucHVzaChgJHthc3Qua2V5fT0ke2J1aWxkKGFzdC52YWx1ZSwgb3B0aW9ucyl9YCk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgfVxuICByZXR1cm4gb3V0cHV0LmpvaW4oJycpO1xufVxuXG5mdW5jdGlvbiBjb21wYWN0KGFycmF5OiBPcHRpb248c3RyaW5nPltdKTogc3RyaW5nW10ge1xuICBjb25zdCBuZXdBcnJheTogYW55W10gPSBbXTtcbiAgYXJyYXkuZm9yRWFjaChhID0+IHtcbiAgICBpZiAodHlwZW9mIGEgIT09ICd1bmRlZmluZWQnICYmIGEgIT09IG51bGwgJiYgYSAhPT0gJycpIHtcbiAgICAgIG5ld0FycmF5LnB1c2goYSk7XG4gICAgfVxuICB9KTtcbiAgcmV0dXJuIG5ld0FycmF5O1xufVxuIl0sInNvdXJjZVJvb3QiOiIifQ==