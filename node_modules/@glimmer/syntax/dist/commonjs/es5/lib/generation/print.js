'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.default = build;

var _tokenizerEventHandlers = require('../parser/tokenizer-event-handlers');

var _util = require('./util');

function unreachable() {
    throw new Error('unreachable');
}
function build(ast) {
    var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : { entityEncoding: 'transformed' };

    if (!ast) {
        return '';
    }
    function buildEach(asts) {
        return asts.map(function (node) {
            return build(node, options);
        });
    }
    function pathParams(ast) {
        var path = void 0;
        switch (ast.type) {
            case 'MustacheStatement':
            case 'SubExpression':
            case 'ElementModifierStatement':
            case 'BlockStatement':
                path = build(ast.path, options);
                break;
            case 'PartialStatement':
                path = build(ast.name, options);
                break;
            default:
                return unreachable();
        }
        return compactJoin([path, buildEach(ast.params).join(' '), build(ast.hash, options)], ' ');
    }
    function compactJoin(array, delimiter) {
        return compact(array).join(delimiter || '');
    }
    function blockParams(block) {
        var params = block.program.blockParams;
        if (params.length) {
            return ' as |' + params.join(' ') + '|';
        }
        return null;
    }
    function openBlock(block) {
        return ['{{#', pathParams(block), blockParams(block), '}}'].join('');
    }
    function closeBlock(block) {
        return ['{{/', build(block.path, options), '}}'].join('');
    }
    var output = [];
    switch (ast.type) {
        case 'Program':
        case 'Block':
        case 'Template':
            {
                var chainBlock = ast.chained && ast.body[0];
                if (chainBlock) {
                    chainBlock.chained = true;
                }
                var body = buildEach(ast.body).join('');
                output.push(body);
            }
            break;
        case 'ElementNode':
            output.push('<', ast.tag);
            if (ast.attributes.length) {
                output.push(' ', buildEach(ast.attributes).join(' '));
            }
            if (ast.modifiers.length) {
                output.push(' ', buildEach(ast.modifiers).join(' '));
            }
            if (ast.comments.length) {
                output.push(' ', buildEach(ast.comments).join(' '));
            }
            if (ast.blockParams.length) {
                output.push(' ', 'as', ' ', '|' + ast.blockParams.join(' ') + '|');
            }
            if (_tokenizerEventHandlers.voidMap[ast.tag]) {
                if (ast.selfClosing) {
                    output.push(' /');
                }
                output.push('>');
            } else if (ast.selfClosing) {
                output.push(' />');
            } else {
                output.push('>');
                output.push.apply(output, buildEach(ast.children));
                output.push('</', ast.tag, '>');
            }
            break;
        case 'AttrNode':
            if (ast.value.type === 'TextNode') {
                if (ast.value.chars !== '') {
                    output.push(ast.name, '=');
                    output.push('"', options.entityEncoding === 'raw' ? ast.value.chars : (0, _util.escapeAttrValue)(ast.value.chars), '"');
                } else {
                    output.push(ast.name);
                }
            } else {
                output.push(ast.name, '=');
                // ast.value is mustache or concat
                output.push(build(ast.value, options));
            }
            break;
        case 'ConcatStatement':
            output.push('"');
            ast.parts.forEach(function (node) {
                if (node.type === 'TextNode') {
                    output.push(options.entityEncoding === 'raw' ? node.chars : (0, _util.escapeAttrValue)(node.chars));
                } else {
                    output.push(build(node, options));
                }
            });
            output.push('"');
            break;
        case 'TextNode':
            output.push(options.entityEncoding === 'raw' ? ast.chars : (0, _util.escapeText)(ast.chars));
            break;
        case 'MustacheStatement':
            {
                output.push(compactJoin(['{{', pathParams(ast), '}}']));
            }
            break;
        case 'MustacheCommentStatement':
            {
                output.push(compactJoin(['{{!--', ast.value, '--}}']));
            }
            break;
        case 'ElementModifierStatement':
            {
                output.push(compactJoin(['{{', pathParams(ast), '}}']));
            }
            break;
        case 'PathExpression':
            output.push(ast.original);
            break;
        case 'SubExpression':
            {
                output.push('(', pathParams(ast), ')');
            }
            break;
        case 'BooleanLiteral':
            output.push(ast.value ? 'true' : 'false');
            break;
        case 'BlockStatement':
            {
                var lines = [];
                if (ast.chained) {
                    lines.push(['{{else ', pathParams(ast), '}}'].join(''));
                } else {
                    lines.push(openBlock(ast));
                }
                lines.push(build(ast.program, options));
                if (ast.inverse) {
                    if (!ast.inverse.chained) {
                        lines.push('{{else}}');
                    }
                    lines.push(build(ast.inverse, options));
                }
                if (!ast.chained) {
                    lines.push(closeBlock(ast));
                }
                output.push(lines.join(''));
            }
            break;
        case 'PartialStatement':
            {
                output.push(compactJoin(['{{>', pathParams(ast), '}}']));
            }
            break;
        case 'CommentStatement':
            {
                output.push(compactJoin(['<!--', ast.value, '-->']));
            }
            break;
        case 'StringLiteral':
            {
                output.push('"' + ast.value + '"');
            }
            break;
        case 'NumberLiteral':
            {
                output.push(String(ast.value));
            }
            break;
        case 'UndefinedLiteral':
            {
                output.push('undefined');
            }
            break;
        case 'NullLiteral':
            {
                output.push('null');
            }
            break;
        case 'Hash':
            {
                output.push(ast.pairs.map(function (pair) {
                    return build(pair, options);
                }).join(' '));
            }
            break;
        case 'HashPair':
            {
                output.push(ast.key + '=' + build(ast.value, options));
            }
            break;
    }
    return output.join('');
}
function compact(array) {
    var newArray = [];
    array.forEach(function (a) {
        if (typeof a !== 'undefined' && a !== null && a !== '') {
            newArray.push(a);
        }
    });
    return newArray;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL3N5bnRheC9saWIvZ2VuZXJhdGlvbi9wcmludC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztrQkFhYyxLOzs7O0FBVmQ7O0FBRUEsU0FBQSxXQUFBLEdBQW9CO0FBQ2xCLFVBQU0sSUFBQSxLQUFBLENBQU4sYUFBTSxDQUFOO0FBQ0Q7QUFNYSxTQUFBLEtBQUEsQ0FBQSxHQUFBLEVBRStDO0FBQUEsUUFBM0QsVUFBMkQsVUFBQSxNQUFBLEdBQUEsQ0FBQSxJQUFBLFVBQUEsQ0FBQSxNQUFBLFNBQUEsR0FBQSxVQUFBLENBQUEsQ0FBQSxHQUFqQyxFQUFFLGdCQUZoQixhQUVjLEVBQWlDOztBQUUzRCxRQUFJLENBQUosR0FBQSxFQUFVO0FBQ1IsZUFBQSxFQUFBO0FBQ0Q7QUFFRCxhQUFBLFNBQUEsQ0FBQSxJQUFBLEVBQW1DO0FBQ2pDLGVBQU8sS0FBQSxHQUFBLENBQVMsVUFBQSxJQUFBLEVBQUE7QUFBQSxtQkFBUSxNQUFBLElBQUEsRUFBeEIsT0FBd0IsQ0FBUjtBQUFoQixTQUFPLENBQVA7QUFDRDtBQUVELGFBQUEsVUFBQSxDQUFBLEdBQUEsRUFBaUM7QUFDL0IsWUFBQSxPQUFBLEtBQUEsQ0FBQTtBQUVBLGdCQUFRLElBQVIsSUFBQTtBQUNFLGlCQUFBLG1CQUFBO0FBQ0EsaUJBQUEsZUFBQTtBQUNBLGlCQUFBLDBCQUFBO0FBQ0EsaUJBQUEsZ0JBQUE7QUFDRSx1QkFBTyxNQUFNLElBQU4sSUFBQSxFQUFQLE9BQU8sQ0FBUDtBQUNBO0FBQ0YsaUJBQUEsa0JBQUE7QUFDRSx1QkFBTyxNQUFNLElBQU4sSUFBQSxFQUFQLE9BQU8sQ0FBUDtBQUNBO0FBQ0Y7QUFDRSx1QkFBQSxhQUFBO0FBWEo7QUFjQSxlQUFPLFlBQVksQ0FBQSxJQUFBLEVBQU8sVUFBVSxJQUFWLE1BQUEsRUFBQSxJQUFBLENBQVAsR0FBTyxDQUFQLEVBQXdDLE1BQU0sSUFBTixJQUFBLEVBQXBELE9BQW9E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S0o7QUE4S0EsV0FBTyxPQUFBLElBQUEsQ0FBUCxFQUFPLENBQVA7QUFDRDtBQUVELFNBQUEsT0FBQSxDQUFBLEtBQUEsRUFBd0M7QUFDdEMsUUFBTSxXQUFOLEVBQUE7QUFDQSxVQUFBLE9BQUEsQ0FBYyxVQUFBLENBQUEsRUFBSTtBQUNoQixZQUFJLE9BQUEsQ0FBQSxLQUFBLFdBQUEsSUFBNEIsTUFBNUIsSUFBQSxJQUEwQyxNQUE5QyxFQUFBLEVBQXdEO0FBQ3RELHFCQUFBLElBQUEsQ0FBQSxDQUFBO0FBQ0Q7QUFISCxLQUFBO0FBS0EsV0FBQSxRQUFBO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPcHRpb24gfSBmcm9tICdAZ2xpbW1lci9pbnRlcmZhY2VzJztcbmltcG9ydCAqIGFzIEFTVCBmcm9tICcuLi90eXBlcy9ub2Rlcyc7XG5pbXBvcnQgeyB2b2lkTWFwIH0gZnJvbSAnLi4vcGFyc2VyL3Rva2VuaXplci1ldmVudC1oYW5kbGVycyc7XG5pbXBvcnQgeyBlc2NhcGVUZXh0LCBlc2NhcGVBdHRyVmFsdWUgfSBmcm9tICcuL3V0aWwnO1xuXG5mdW5jdGlvbiB1bnJlYWNoYWJsZSgpOiBuZXZlciB7XG4gIHRocm93IG5ldyBFcnJvcigndW5yZWFjaGFibGUnKTtcbn1cblxuaW50ZXJmYWNlIFByaW50ZXJPcHRpb25zIHtcbiAgZW50aXR5RW5jb2Rpbmc6ICd0cmFuc2Zvcm1lZCcgfCAncmF3Jztcbn1cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gYnVpbGQoXG4gIGFzdDogQVNULk5vZGUsXG4gIG9wdGlvbnM6IFByaW50ZXJPcHRpb25zID0geyBlbnRpdHlFbmNvZGluZzogJ3RyYW5zZm9ybWVkJyB9XG4pOiBzdHJpbmcge1xuICBpZiAoIWFzdCkge1xuICAgIHJldHVybiAnJztcbiAgfVxuXG4gIGZ1bmN0aW9uIGJ1aWxkRWFjaChhc3RzOiBBU1QuTm9kZVtdKTogc3RyaW5nW10ge1xuICAgIHJldHVybiBhc3RzLm1hcChub2RlID0+IGJ1aWxkKG5vZGUsIG9wdGlvbnMpKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIHBhdGhQYXJhbXMoYXN0OiBBU1QuTm9kZSk6IHN0cmluZyB7XG4gICAgbGV0IHBhdGg6IHN0cmluZztcblxuICAgIHN3aXRjaCAoYXN0LnR5cGUpIHtcbiAgICAgIGNhc2UgJ011c3RhY2hlU3RhdGVtZW50JzpcbiAgICAgIGNhc2UgJ1N1YkV4cHJlc3Npb24nOlxuICAgICAgY2FzZSAnRWxlbWVudE1vZGlmaWVyU3RhdGVtZW50JzpcbiAgICAgIGNhc2UgJ0Jsb2NrU3RhdGVtZW50JzpcbiAgICAgICAgcGF0aCA9IGJ1aWxkKGFzdC5wYXRoLCBvcHRpb25zKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdQYXJ0aWFsU3RhdGVtZW50JzpcbiAgICAgICAgcGF0aCA9IGJ1aWxkKGFzdC5uYW1lLCBvcHRpb25zKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gdW5yZWFjaGFibGUoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gY29tcGFjdEpvaW4oW3BhdGgsIGJ1aWxkRWFjaChhc3QucGFyYW1zKS5qb2luKCcgJyksIGJ1aWxkKGFzdC5oYXNoLCBvcHRpb25zKV0sICcgJyk7XG4gIH1cblxuICBmdW5jdGlvbiBjb21wYWN0Sm9pbihhcnJheTogT3B0aW9uPHN0cmluZz5bXSwgZGVsaW1pdGVyPzogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gY29tcGFjdChhcnJheSkuam9pbihkZWxpbWl0ZXIgfHwgJycpO1xuICB9XG5cbiAgZnVuY3Rpb24gYmxvY2tQYXJhbXMoYmxvY2s6IEFTVC5CbG9ja1N0YXRlbWVudCk6IE9wdGlvbjxzdHJpbmc+IHtcbiAgICBjb25zdCBwYXJhbXMgPSBibG9jay5wcm9ncmFtLmJsb2NrUGFyYW1zO1xuICAgIGlmIChwYXJhbXMubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gYCBhcyB8JHtwYXJhbXMuam9pbignICcpfXxgO1xuICAgIH1cblxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgZnVuY3Rpb24gb3BlbkJsb2NrKGJsb2NrOiBBU1QuQmxvY2tTdGF0ZW1lbnQpOiBzdHJpbmcge1xuICAgIHJldHVybiBbJ3t7IycsIHBhdGhQYXJhbXMoYmxvY2spLCBibG9ja1BhcmFtcyhibG9jayksICd9fSddLmpvaW4oJycpO1xuICB9XG5cbiAgZnVuY3Rpb24gY2xvc2VCbG9jayhibG9jazogYW55KTogc3RyaW5nIHtcbiAgICByZXR1cm4gWyd7ey8nLCBidWlsZChibG9jay5wYXRoLCBvcHRpb25zKSwgJ319J10uam9pbignJyk7XG4gIH1cblxuICBjb25zdCBvdXRwdXQ6IHN0cmluZ1tdID0gW107XG5cbiAgc3dpdGNoIChhc3QudHlwZSkge1xuICAgIGNhc2UgJ1Byb2dyYW0nOlxuICAgIGNhc2UgJ0Jsb2NrJzpcbiAgICBjYXNlICdUZW1wbGF0ZSc6XG4gICAgICB7XG4gICAgICAgIGNvbnN0IGNoYWluQmxvY2sgPSBhc3QuY2hhaW5lZCAmJiBhc3QuYm9keVswXTtcbiAgICAgICAgaWYgKGNoYWluQmxvY2spIHtcbiAgICAgICAgICAoY2hhaW5CbG9jayBhcyBBU1QuQmxvY2tTdGF0ZW1lbnQpLmNoYWluZWQgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGJvZHkgPSBidWlsZEVhY2goYXN0LmJvZHkpLmpvaW4oJycpO1xuICAgICAgICBvdXRwdXQucHVzaChib2R5KTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ0VsZW1lbnROb2RlJzpcbiAgICAgIG91dHB1dC5wdXNoKCc8JywgYXN0LnRhZyk7XG4gICAgICBpZiAoYXN0LmF0dHJpYnV0ZXMubGVuZ3RoKSB7XG4gICAgICAgIG91dHB1dC5wdXNoKCcgJywgYnVpbGRFYWNoKGFzdC5hdHRyaWJ1dGVzKS5qb2luKCcgJykpO1xuICAgICAgfVxuICAgICAgaWYgKGFzdC5tb2RpZmllcnMubGVuZ3RoKSB7XG4gICAgICAgIG91dHB1dC5wdXNoKCcgJywgYnVpbGRFYWNoKGFzdC5tb2RpZmllcnMpLmpvaW4oJyAnKSk7XG4gICAgICB9XG4gICAgICBpZiAoYXN0LmNvbW1lbnRzLmxlbmd0aCkge1xuICAgICAgICBvdXRwdXQucHVzaCgnICcsIGJ1aWxkRWFjaChhc3QuY29tbWVudHMpLmpvaW4oJyAnKSk7XG4gICAgICB9XG5cbiAgICAgIGlmIChhc3QuYmxvY2tQYXJhbXMubGVuZ3RoKSB7XG4gICAgICAgIG91dHB1dC5wdXNoKCcgJywgJ2FzJywgJyAnLCBgfCR7YXN0LmJsb2NrUGFyYW1zLmpvaW4oJyAnKX18YCk7XG4gICAgICB9XG5cbiAgICAgIGlmICh2b2lkTWFwW2FzdC50YWddKSB7XG4gICAgICAgIGlmIChhc3Quc2VsZkNsb3NpbmcpIHtcbiAgICAgICAgICBvdXRwdXQucHVzaCgnIC8nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIG91dHB1dC5wdXNoKCc+Jyk7XG4gICAgICB9IGVsc2UgaWYgKGFzdC5zZWxmQ2xvc2luZykge1xuICAgICAgICBvdXRwdXQucHVzaCgnIC8+Jyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvdXRwdXQucHVzaCgnPicpO1xuICAgICAgICBvdXRwdXQucHVzaC5hcHBseShvdXRwdXQsIGJ1aWxkRWFjaChhc3QuY2hpbGRyZW4pKTtcbiAgICAgICAgb3V0cHV0LnB1c2goJzwvJywgYXN0LnRhZywgJz4nKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ0F0dHJOb2RlJzpcbiAgICAgIGlmIChhc3QudmFsdWUudHlwZSA9PT0gJ1RleHROb2RlJykge1xuICAgICAgICBpZiAoYXN0LnZhbHVlLmNoYXJzICE9PSAnJykge1xuICAgICAgICAgIG91dHB1dC5wdXNoKGFzdC5uYW1lLCAnPScpO1xuICAgICAgICAgIG91dHB1dC5wdXNoKFxuICAgICAgICAgICAgJ1wiJyxcbiAgICAgICAgICAgIG9wdGlvbnMuZW50aXR5RW5jb2RpbmcgPT09ICdyYXcnID8gYXN0LnZhbHVlLmNoYXJzIDogZXNjYXBlQXR0clZhbHVlKGFzdC52YWx1ZS5jaGFycyksXG4gICAgICAgICAgICAnXCInXG4gICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBvdXRwdXQucHVzaChhc3QubmFtZSk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG91dHB1dC5wdXNoKGFzdC5uYW1lLCAnPScpO1xuICAgICAgICAvLyBhc3QudmFsdWUgaXMgbXVzdGFjaGUgb3IgY29uY2F0XG4gICAgICAgIG91dHB1dC5wdXNoKGJ1aWxkKGFzdC52YWx1ZSwgb3B0aW9ucykpO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnQ29uY2F0U3RhdGVtZW50JzpcbiAgICAgIG91dHB1dC5wdXNoKCdcIicpO1xuICAgICAgYXN0LnBhcnRzLmZvckVhY2goKG5vZGU6IEFTVC5UZXh0Tm9kZSB8IEFTVC5NdXN0YWNoZVN0YXRlbWVudCkgPT4ge1xuICAgICAgICBpZiAobm9kZS50eXBlID09PSAnVGV4dE5vZGUnKSB7XG4gICAgICAgICAgb3V0cHV0LnB1c2gob3B0aW9ucy5lbnRpdHlFbmNvZGluZyA9PT0gJ3JhdycgPyBub2RlLmNoYXJzIDogZXNjYXBlQXR0clZhbHVlKG5vZGUuY2hhcnMpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBvdXRwdXQucHVzaChidWlsZChub2RlLCBvcHRpb25zKSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgb3V0cHV0LnB1c2goJ1wiJyk7XG4gICAgICBicmVhaztcbiAgICBjYXNlICdUZXh0Tm9kZSc6XG4gICAgICBvdXRwdXQucHVzaChvcHRpb25zLmVudGl0eUVuY29kaW5nID09PSAncmF3JyA/IGFzdC5jaGFycyA6IGVzY2FwZVRleHQoYXN0LmNoYXJzKSk7XG4gICAgICBicmVhaztcbiAgICBjYXNlICdNdXN0YWNoZVN0YXRlbWVudCc6XG4gICAgICB7XG4gICAgICAgIG91dHB1dC5wdXNoKGNvbXBhY3RKb2luKFsne3snLCBwYXRoUGFyYW1zKGFzdCksICd9fSddKSk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdNdXN0YWNoZUNvbW1lbnRTdGF0ZW1lbnQnOlxuICAgICAge1xuICAgICAgICBvdXRwdXQucHVzaChjb21wYWN0Sm9pbihbJ3t7IS0tJywgYXN0LnZhbHVlLCAnLS19fSddKSk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdFbGVtZW50TW9kaWZpZXJTdGF0ZW1lbnQnOlxuICAgICAge1xuICAgICAgICBvdXRwdXQucHVzaChjb21wYWN0Sm9pbihbJ3t7JywgcGF0aFBhcmFtcyhhc3QpLCAnfX0nXSkpO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnUGF0aEV4cHJlc3Npb24nOlxuICAgICAgb3V0cHV0LnB1c2goYXN0Lm9yaWdpbmFsKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ1N1YkV4cHJlc3Npb24nOlxuICAgICAge1xuICAgICAgICBvdXRwdXQucHVzaCgnKCcsIHBhdGhQYXJhbXMoYXN0KSwgJyknKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ0Jvb2xlYW5MaXRlcmFsJzpcbiAgICAgIG91dHB1dC5wdXNoKGFzdC52YWx1ZSA/ICd0cnVlJyA6ICdmYWxzZScpO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnQmxvY2tTdGF0ZW1lbnQnOlxuICAgICAge1xuICAgICAgICBjb25zdCBsaW5lczogc3RyaW5nW10gPSBbXTtcblxuICAgICAgICBpZiAoYXN0LmNoYWluZWQpIHtcbiAgICAgICAgICBsaW5lcy5wdXNoKFsne3tlbHNlICcsIHBhdGhQYXJhbXMoYXN0KSwgJ319J10uam9pbignJykpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGxpbmVzLnB1c2gob3BlbkJsb2NrKGFzdCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGluZXMucHVzaChidWlsZChhc3QucHJvZ3JhbSwgb3B0aW9ucykpO1xuXG4gICAgICAgIGlmIChhc3QuaW52ZXJzZSkge1xuICAgICAgICAgIGlmICghYXN0LmludmVyc2UuY2hhaW5lZCkge1xuICAgICAgICAgICAgbGluZXMucHVzaCgne3tlbHNlfX0nKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgbGluZXMucHVzaChidWlsZChhc3QuaW52ZXJzZSwgb3B0aW9ucykpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFhc3QuY2hhaW5lZCkge1xuICAgICAgICAgIGxpbmVzLnB1c2goY2xvc2VCbG9jayhhc3QpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIG91dHB1dC5wdXNoKGxpbmVzLmpvaW4oJycpKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ1BhcnRpYWxTdGF0ZW1lbnQnOlxuICAgICAge1xuICAgICAgICBvdXRwdXQucHVzaChjb21wYWN0Sm9pbihbJ3t7PicsIHBhdGhQYXJhbXMoYXN0KSwgJ319J10pKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ0NvbW1lbnRTdGF0ZW1lbnQnOlxuICAgICAge1xuICAgICAgICBvdXRwdXQucHVzaChjb21wYWN0Sm9pbihbJzwhLS0nLCBhc3QudmFsdWUsICctLT4nXSkpO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnU3RyaW5nTGl0ZXJhbCc6XG4gICAgICB7XG4gICAgICAgIG91dHB1dC5wdXNoKGBcIiR7YXN0LnZhbHVlfVwiYCk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdOdW1iZXJMaXRlcmFsJzpcbiAgICAgIHtcbiAgICAgICAgb3V0cHV0LnB1c2goU3RyaW5nKGFzdC52YWx1ZSkpO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnVW5kZWZpbmVkTGl0ZXJhbCc6XG4gICAgICB7XG4gICAgICAgIG91dHB1dC5wdXNoKCd1bmRlZmluZWQnKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ051bGxMaXRlcmFsJzpcbiAgICAgIHtcbiAgICAgICAgb3V0cHV0LnB1c2goJ251bGwnKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ0hhc2gnOlxuICAgICAge1xuICAgICAgICBvdXRwdXQucHVzaChcbiAgICAgICAgICBhc3QucGFpcnNcbiAgICAgICAgICAgIC5tYXAocGFpciA9PiB7XG4gICAgICAgICAgICAgIHJldHVybiBidWlsZChwYWlyLCBvcHRpb25zKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuam9pbignICcpXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdIYXNoUGFpcic6XG4gICAgICB7XG4gICAgICAgIG91dHB1dC5wdXNoKGAke2FzdC5rZXl9PSR7YnVpbGQoYXN0LnZhbHVlLCBvcHRpb25zKX1gKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICB9XG4gIHJldHVybiBvdXRwdXQuam9pbignJyk7XG59XG5cbmZ1bmN0aW9uIGNvbXBhY3QoYXJyYXk6IE9wdGlvbjxzdHJpbmc+W10pOiBzdHJpbmdbXSB7XG4gIGNvbnN0IG5ld0FycmF5OiBhbnlbXSA9IFtdO1xuICBhcnJheS5mb3JFYWNoKGEgPT4ge1xuICAgIGlmICh0eXBlb2YgYSAhPT0gJ3VuZGVmaW5lZCcgJiYgYSAhPT0gbnVsbCAmJiBhICE9PSAnJykge1xuICAgICAgbmV3QXJyYXkucHVzaChhKTtcbiAgICB9XG4gIH0pO1xuICByZXR1cm4gbmV3QXJyYXk7XG59XG4iXSwic291cmNlUm9vdCI6IiJ9